CloudFormation Resources Generated By SAM
=========================================

.. contents::
  :local:
  :backlinks: none

When you create a Serverless Function or a Serverlesss API, SAM will create additional AWS resources to wire everything up.
For example, when you create a ``AWS::Serverless::Function``, SAM will create a Lambda Function resource
along with an IAM Role resource to give appropriate permissions for your function. This document describes all 
such generated resources, how they are named, and how to refer to them in your SAM template.


AWS::Serverless::Function
-------------------------
Given a Function defined as follows:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...

Following resources will be generated:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Function              MyFunction
AWS::IAM::Role                     MyFunction\ **Role**
================================== ================================

With AutoPublishAlias Property
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      AutoPublishAlias: live
      ...


Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Version               MyFunction\ **Version**\ *SHA* (10 digits of SHA256 of CodeUri)
AWS::Lambda::Alias                 MyFunction\ **Alias**\ *live*
================================== ================================


With DeploymentPreference Property
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      AutoPublishAlias: live
      DeploymentPreference: 
        Type: Linear10PercentEvery10Minutes
        Role: "arn"
      ...


Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::CodeDeploy::Application       ServerlessDeploymentApplication (only one per stack)
AWS::CodeDeploy::DeploymentGroup   MyFunction\ **DeploymentGroup** 
AWS::IAM::Role                     CodeDeployServiceRole
================================== ================================

  NOTE: ``AWS::IAM::Role`` resources are only generated if no Role parameter is supplied for DeploymentPreference

With Events
~~~~~~~~~~~

A common theme with all Events is SAM will generate a ``AWS::Lambda::Permission`` resource to give event source 
permission to invoke the function. Other generated resources depend on the specific event type.

API
^^^
This is called an "Implicit API". There can be many functions in the template that define these APIs. Behind the 
scenes, SAM will collect all implicit APIs from all Functions in the template, generate a Swagger, and create an 
implicit ``AWS::Serverless::Api`` using this Swagger. This API defaults to a StageName called "Prod" that cannot be
configured.

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Events:
        ThumbnailApi:
          Type: Api
          Properties:
            Path: /thumbnail
            Method: GET
      ...

Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::ApiGateway::RestApi           *ServerlessRestApi* 
AWS::ApiGateway::Stage             *ServerlessRestApi*\ **Prod**\ Stage 
AWS::ApiGateway::Deployment        *ServerlessRestApi*\ Deployment\ *SHA* (10 Digits of SHA256 of Swagger)
AWS::Lambda::Permissions           MyFunction\ **ThumbnailApi**\ Permission\ **Prod** 
                                   (Prod is the default Stage Name for implicit APIs)
================================== ================================


  NOTE: ``ServerlessRestApi*`` resources are generated one per stack.

S3
^^^

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Events:
        S3Trigger:
          Type: S3
          Properties:
            Bucket: !Ref MyBucket
            Events: s3:ObjectCreated:*
      ...

  MyBucket:
    Type: AWS::S3::Bucket

Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Permissions           MyFunction\ **S3Trigger**\ Permission
AWS::S3::Bucket                    Existing MyBucket resource is modified to append ``NotificationConfiguration`` 
                                   property where the Lambda function trigger is defined
================================== ================================

  NOTE: You **must** refer to an S3 Bucket defined in the same template. This is for two reasons:
  
  1. SAM needs to add a ``NotificationConfiguration`` property to the bucket resource by reading and modifying the 
  resource definition

  2. Lambda triggers are specified as a property on the bucket resource. Since CloudFormation cannot modify a resource
  created outside of the stack, this bucket needs to be defined within the template.

SNS
^^^

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Events:
        MyTrigger:
          Type: SNS
          Properties:
            Topic: arn:aws:sns:us-east-1:123456789012:my_topic
      ...

Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Permissions           MyFunction\ **MyTrigger**\ Permission
AWS::SNS::Subscription             MyFunction\ **MyTrigger** 
================================== ================================

Kinesis
^^^^^^^

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Events:
        MyTrigger:
          Type: Kinesis
          Properties:
            Stream: arn:aws:kinesis:us-east-1:123456789012:stream/my-stream
            StartingPosition: TRIM_HORIZON      
      ...

Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Permissions           MyFunction\ **MyTrigger**\ Permission
AWS::Lambda::EventSourceMapping    MyFunction\ **MyTrigger** 
================================== ================================

SQS
^^^^^^^

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Events:
        MyTrigger:
          Type: SQS
          Properties:
            Queue: arn:aws:sqs:us-east-1:123456789012:my-queue
      ...

Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Permissions           MyFunction\ **MyTrigger**\ Permission
AWS::Lambda::EventSourceMapping    MyFunction\ **MyTrigger** 
================================== ================================

DynamoDb
^^^^^^^^

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Events:
        MyTrigger:
          Type: DynamoDb
          Properties:
            Stream: arn:aws:dynamodb:us-east-1:123456789012:table/TestTable/stream/2016-08-11T21:21:33.291
            StartingPosition: TRIM_HORIZON      
      ...

Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Permissions           MyFunction\ **MyTrigger**\ Permission
AWS::Lambda::EventSourceMapping    MyFunction\ **MyTrigger** 
================================== ================================

Schedule
^^^^^^^^

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Events:
        MyTimer:
          Type: Schedule
          Properties:
            Input: rate(5 minutes)
      ...

Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Permissions           MyFunction\ **MyTimer**\ Permission
AWS::Events::Rule                  MyFunction\ **MyTimer** 
================================== ================================

CloudWatchEvent
^^^^^^^^^^^^^^^

Example:

.. code:: yaml

  MyFunction:
    Type: AWS::Serverless::Function
    Properties:
      ...
      Events:
        OnTerminate:
          Type: CloudWatchEvent
          Properties:
            Pattern:
              detail:
                state:
                  - terminated   
      ...

Additional generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::Lambda::Permissions           MyFunction\ **OnTerminate**\ Permission
AWS::Events::Rule                  MyFunction\ **OnTerminate** 
================================== ================================


AWS::Serverless::Api
--------------------

In contrast to Implict APIs, you can explicitly define your API resource by providing an entire Swagger definition of 
your API.

Example:

.. code:: yaml

  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      ...
      DefinitionUri: s3://bucket/swagger.json
      StageName: dev
      ...

Generated resources:

================================== ================================
CloudFormation Resource Type       Logical ID 
================================== ================================
AWS::ApiGateway::RestApi           MyApi
AWS::ApiGateway::Stage             MyApi\ **dev**\ Stage 
AWS::ApiGateway::Deployment        MyApi\ Deployment\ *SHA* (10 Digits of SHA256 of DefinitionUri or DefinitionBody value)
================================== ================================

  NOTE: By just specifying AWS::Serverless::Api resource, SAM will *not* add permission for API Gateway to invoke the 
  the Lambda Function backing the APIs. You should explicitly re-define all APIs under ``Events`` section of the
  AWS::Serverless::Function resource but include a `RestApiId` property that references the AWS::Serverless::Api 
  resource. SAM will add permission for these APIs to invoke the function.

  Example:

  .. code:: yaml

    MyFunction:
      Type: AWS::Serverless::Function
      Properties:
        ...
        Events:
          GetApi:
            Type: Api
            Properties:
              Path: /
              Method: GET

              # This is the property that instructs SAM to just add permissions for an explicitly defined API
              RestApiId: !Ref MyApi




